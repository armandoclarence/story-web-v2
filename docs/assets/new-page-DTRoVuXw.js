var k=o=>{throw TypeError(o)};var I=(o,t,e)=>t.has(o)||k("Cannot "+e);var a=(o,t,e)=>(I(o,t,"read from private field"),e?e.call(o):t.get(o)),m=(o,t,e)=>t.has(o)?k("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(o):t.set(o,e),u=(o,t,e,n)=>(I(o,t,"write to private field"),n?n.call(o,e):t.set(o,e),e),r=(o,t,e)=>(I(o,t,"access private method"),e);import{S as T,C,c as P}from"./index-DxFbdW2W.js";import{g as N,a as F}from"./form-templates-CE6QAyK3.js";import{a as x}from"./ui-templates-4hofMUCo.js";import{M as H}from"./map-CHyzhXe1.js";var l,w;class D{constructor({view:t,model:e}){m(this,l);m(this,w);u(this,l,t),u(this,w,e)}async showNewFormMap(){a(this,l).showMapLoading();try{await a(this,l).initialMap()}catch(t){console.error("showNewFormMap: error:",t)}finally{a(this,l).hideMapLoading()}}async postNewStory({description:t,photo:e,lat:n,lon:d}){a(this,l).showSubmitLoadingButton();try{const f={description:t,photo:e,lat:n,lon:d},y=await a(this,w).storeNewStory(f);if(!y.ok){console.error("postNewStory: response:",y),a(this,l).storeFailed(y.message);return}a(this,l).storeSuccessfully(y.message,y.data)}catch(f){console.error("postNewStory: error:",f),a(this,l).storeFailed(f.message)}finally{a(this,l).hideSubmitLoadingButton()}}}l=new WeakMap,w=new WeakMap;var p,i,h,L,c,g,s,E,v,S,B,b,M;class ${constructor(){m(this,s);m(this,p);m(this,i);m(this,h);m(this,L,!1);m(this,c,[]);m(this,g,null)}async render(){return N()}async afterRender(){u(this,p,new D({view:this,model:T})),u(this,c,[]),a(this,p).showNewFormMap(),r(this,s,E).call(this)}async initialMap(){u(this,g,await H.build("#map",{zoom:15,locate:!0}));const t=a(this,g).getCenter();r(this,s,v).call(this,t.latitude,t.longitude);const e=a(this,g).addMarker([t.latitude,t.longitude],{draggable:"true"});e.addEventListener("move",n=>{const d=n.target.getLatLng();r(this,s,v).call(this,d.lat,d.lng)}),a(this,g).addMapEventListener("click",n=>{e.setLatLng(n.latlng),n.sourceTarget.flyTo(n.latlng)})}storeSuccessfully(t){alert(t),console.log(t),this.clearForm(),location.hash="/"}storeFailed(t){alert(t),console.log(t)}clearForm(){a(this,i).reset()}showMapLoading(){document.getElementById("map-loading-container").innerHTML=x()}hideMapLoading(){document.getElementById("map-loading-container").innerHTML=""}showSubmitLoadingButton(){document.getElementById("submit-button-container").innerHTML=`
      <button class="btn" type="submit" disabled>
        <i class="fas fa-spinner loader-button"></i> Buat Cerita
      </button>
    `}hideSubmitLoadingButton(){document.getElementById("submit-button-container").innerHTML=`
      <button class="btn" type="submit">Buat Cerita</button>
    `}}p=new WeakMap,i=new WeakMap,h=new WeakMap,L=new WeakMap,c=new WeakMap,g=new WeakMap,s=new WeakSet,E=function(){u(this,i,document.getElementById("new-form")),a(this,i).addEventListener("submit",async e=>{if(e.preventDefault(),a(this,i).elements.namedItem("description").value===""){alert("Keterangan tidak boleh kosong");return}if(a(this,c).length===0){alert("Dokumentasi tidak boleh kosong");return}if(a(this,i).elements.namedItem("latitude").value===""||a(this,i).elements.namedItem("longitude").value===""){alert("Lokasi tidak boleh kosong");return}const n={description:a(this,i).elements.namedItem("description").value,photo:a(this,c),lat:a(this,i).elements.namedItem("latitude").value,lon:a(this,i).elements.namedItem("longitude").value};await a(this,p).postNewStory(n)}),document.getElementById("photo-input").addEventListener("change",async e=>{const n=Object.values(e.target.files).map(async d=>await r(this,s,B).call(this,d));await Promise.all(n),await r(this,s,b).call(this)}),document.getElementById("photo-input-button").addEventListener("click",()=>{a(this,i).elements.namedItem("photo-input").click()});const t=document.getElementById("camera-container");document.getElementById("open-photo-camera-button").addEventListener("click",async e=>{if(t.classList.toggle("open"),u(this,L,t.classList.contains("open")),a(this,L)){e.currentTarget.textContent="Tutup Kamera",r(this,s,S).call(this),await a(this,h).launch();return}e.currentTarget.textContent="Buka Kamera",a(this,h).stop()})},v=function(t,e){a(this,i).elements.namedItem("latitude").value=t,a(this,i).elements.namedItem("longitude").value=e},S=function(){a(this,h)||u(this,h,new C({video:document.getElementById("camera-video"),cameraSelect:document.getElementById("camera-select"),canvas:document.getElementById("camera-canvas")})),a(this,h).addCheeseButtonListener("#camera-take-button",async()=>{const t=await a(this,h).takePicture();await r(this,s,B).call(this,t),await r(this,s,b).call(this)})},B=async function(t){let e=t;t instanceof String&&(e=P(t,"image/png"));const n={id:`${Date.now()}-${Math.random().toString(36).substring(2,9)}`,blob:e};u(this,c,[...a(this,c),n])},b=async function(){const t=a(this,c).reduce((e,n)=>{const d=URL.createObjectURL(n.blob);return e+F(d,n.id)},"");document.getElementById("photo-taken-list").innerHTML=t,document.querySelectorAll("button[data-index]").forEach(e=>e.addEventListener("click",n=>{const d=n.currentTarget.dataset.index;r(this,s,M).call(this,d),r(this,s,b).call(this)}))},M=function(t){const e=a(this,c).findIndex(n=>(n.id||"").toString()===t.toString());if(e!==-1){const n=document.querySelector(`[data-photo-id="${t}"]`);n&&(n.style.transition="all 0.3s ease",n.style.opacity="0",n.style.transform="scale(0.  8)",setTimeout(()=>{a(this,c).splice(e,1),document.getElementById("photo-input").value="",r(this,s,b).call(this)},300))}};export{$ as default};
