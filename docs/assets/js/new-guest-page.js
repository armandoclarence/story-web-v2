var v=o=>{throw TypeError(o)};var f=(o,e,t)=>e.has(o)||v("Cannot "+t);var n=(o,e,t)=>(f(o,e,"read from private field"),t?t.call(o):e.get(o)),u=(o,e,t)=>e.has(o)?v("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(o):e.set(o,t),m=(o,e,t,i)=>(f(o,e,"write to private field"),i?i.call(o,t):e.set(o,t),t),l=(o,e,t)=>(f(o,e,"access private method"),t);import{q as M,I as T,S as P,C,e as F,d as N}from"./index.js";import{g as x,a as G}from"./form-templates.js";import{M as L}from"./map.js";var s,b;class q{constructor({view:e,model:t}){u(this,s);u(this,b);m(this,s,e),m(this,b,t)}async showNewFormMap(){n(this,s).showMapLoading();try{await n(this,s).initialMap()}catch(e){console.error("showNewFormMap: error:",e)}finally{n(this,s).hideMapLoading()}}async postNewStoryGuest(e){if(n(this,s).showSubmitLoadingButton(),!navigator.onLine){try{await M(await T.init(),{type:"new-guest",description:e==null?void 0:e.description,photo:e==null?void 0:e.photo,lat:e==null?void 0:e.lat,lon:e==null?void 0:e.lon}),n(this,s).storeSuccessfully("Anda sedang offline. Cerita akan dikirim saat online kembali.",e)}catch(t){console.error("Failed to queue post offline:",t),n(this,s).storeFailed("Gagal menyimpan cerita secara offline.")}finally{n(this,s).hideSubmitLoadingButton()}return}try{const t=await n(this,b).storeNewStoryGuest(e);if(!t.ok){console.error("postNewStory: response:",t),n(this,s).storeFailed(t.message);return}n(this,s).storeSuccessfully(t.message,t.story)}catch(t){console.error("postNewStory: error:",t),n(this,s).storeFailed(t.message)}finally{n(this,s).hideSubmitLoadingButton()}}}s=new WeakMap,b=new WeakMap;var p,r,d,w,c,h,a,S,I,k,B,y,E;class K{constructor(){u(this,a);u(this,p);u(this,r);u(this,d);u(this,w,!1);u(this,c,[]);u(this,h,null)}async render(){return x(!0,await L.isPermissionsGeolocationGranted())}async afterRender(){m(this,p,new q({view:this,model:P})),m(this,c,[]),n(this,p).showNewFormMap(),l(this,a,S).call(this)}async initialMap(){if(!document.querySelector("#map")||(m(this,h,await L.build("#map",{zoom:15})),!n(this,h)))return;const e=n(this,h).getCenter();n(this,h).changeCamera([e.latitude,e.longitude]),l(this,a,I).call(this,e.latitude,e.longitude);const t=n(this,h).addMarker([e.latitude,e.longitude],{draggable:"true"});t.addEventListener("move",i=>{const g=i.target.getLatLng();l(this,a,I).call(this,g.lat,g.lng)}),n(this,h).addMapEventListener("click",i=>{t.setLatLng(i.latlng),i.sourceTarget.flyTo(i.latlng)})}storeSuccessfully(e){alert(e),console.log(e),this.clearForm(),location.hash="/"}storeFailed(e){alert(e),console.log(e)}clearForm(){n(this,r).reset()}showMapLoading(){document.getElementById("map-loading-container").innerHTML=N()}hideMapLoading(){document.getElementById("map-loading-container").innerHTML=""}showSubmitLoadingButton(){document.getElementById("submit-button-container").innerHTML=`
      <button class="btn" type="submit" disabled>
        <i class="fas fa-spinner loader-button"></i> Buat Cerita
      </button>
    `}hideSubmitLoadingButton(){document.getElementById("submit-button-container").innerHTML=`
      <button class="btn" type="submit">Buat Cerita</button>
    `}}p=new WeakMap,r=new WeakMap,d=new WeakMap,w=new WeakMap,c=new WeakMap,h=new WeakMap,a=new WeakSet,S=function(){m(this,r,document.getElementById("new-form")),n(this,r).addEventListener("submit",async t=>{if(t.preventDefault(),n(this,r).elements.namedItem("description").value===""){alert("Keterangan tidak boleh kosong");return}if(n(this,c).length===0){alert("Dokumentasi tidak boleh kosong");return}let i={description:n(this,r).elements.namedItem("description").value,photo:n(this,c)[0].blob};await L.isPermissionsGeolocationGranted()&&(i={...i,lat:n(this,r).elements.namedItem("latitude").value,lon:n(this,r).elements.namedItem("longitude").value}),await n(this,p).postNewStoryGuest(i)}),document.getElementById("photo-input").addEventListener("change",async t=>{const i=Object.values(t.target.files).map(async g=>await l(this,a,B).call(this,g));await Promise.all(i),await l(this,a,y).call(this)}),document.getElementById("photo-input-button").addEventListener("click",()=>{n(this,r).elements.namedItem("photo-input").click()});const e=document.getElementById("camera-container");document.getElementById("open-photo-camera-button").addEventListener("click",async t=>{l(this,a,k).call(this),m(this,w,e.classList.contains("open")),n(this,w)?(e.classList.remove("open"),t.currentTarget.textContent="Buka Kamera",n(this,d).stop()):(e.classList.add("open"),t.currentTarget.textContent="Tutup Kamera",await n(this,d).launch())})},I=function(e,t){n(this,r).elements.namedItem("latitude").value=e,n(this,r).elements.namedItem("longitude").value=t},k=function(){n(this,d)||m(this,d,new C({video:document.getElementById("camera-video"),cameraSelect:document.getElementById("camera-select"),canvas:document.getElementById("camera-canvas")})),n(this,d).addCheeseButtonListener("#camera-take-button",async()=>{const e=await n(this,d).takePicture();await l(this,a,B).call(this,e),await l(this,a,y).call(this)})},B=async function(e){let t=e;e instanceof String&&(t=F(e,"image/png"));const i={id:`${Date.now()}-${Math.random().toString(36).substring(2,9)}`,blob:t};m(this,c,[...n(this,c),i])},y=async function(){const e=n(this,c).reduce((t,i)=>{const g=URL.createObjectURL(i.blob);return t+G(g,i.id)},"");document.getElementById("photo-taken-list").innerHTML=e,document.querySelectorAll("button[data-index]").forEach(t=>t.addEventListener("click",async i=>{const g=i.currentTarget.dataset.index;l(this,a,E).call(this,g),await l(this,a,y).call(this)}))},E=function(e){const t=n(this,c).findIndex(i=>(i.id||"").toString()===e.toString());if(t!==-1){const i=document.querySelector(`[data-photo-id="${e}"]`);i&&(i.style.transition="all 0.3s ease",i.style.opacity="0",i.style.transform="scale(0.  8)",setTimeout(()=>{n(this,c).splice(t,1),document.getElementById("photo-input").value="",l(this,a,y).call(this)},300))}};export{K as default};
