var S=o=>{throw TypeError(o)};var L=(o,e,t)=>e.has(o)||S("Cannot "+t);var n=(o,e,t)=>(L(o,e,"read from private field"),t?t.call(o):e.get(o)),m=(o,e,t)=>e.has(o)?S("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(o):e.set(o,t),u=(o,e,t,i)=>(L(o,e,"write to private field"),i?i.call(o,t):e.set(o,t),t),l=(o,e,t)=>(L(o,e,"access private method"),t);import{q as M,I as T,S as P,C,e as F,d as N}from"./index.js";import{g as q,a as x}from"./form-templates.js";import{M as w}from"./map.js";var s,b;class G{constructor({view:e,model:t}){m(this,s);m(this,b);u(this,s,e),u(this,b,t)}async showNewFormMap(){n(this,s).showMapLoading();try{await n(this,s).initialMap()}catch(e){console.error("showNewFormMap: error:",e)}finally{n(this,s).hideMapLoading()}}async postNewStory(e){if(n(this,s).showSubmitLoadingButton(),!navigator.onLine){try{await M(await T.init(),{type:"new",description:e==null?void 0:e.description,photo:e==null?void 0:e.photo,lat:e==null?void 0:e.lat,lon:e==null?void 0:e.lon}),n(this,s).storeSuccessfully("Anda sedang offline. Cerita akan dikirim saat online kembali.",e)}catch(t){console.error("Failed to queue post offline:",t),n(this,s).storeFailed("Gagal menyimpan cerita secara offline.")}finally{n(this,s).hideSubmitLoadingButton()}return}try{const t=await n(this,b).storeNewStory(e);if(!t.ok){console.error("postNewStory: response:",t),n(this,s).storeFailed(t.message);return}n(this,s).storeSuccessfully(t.message,t.data)}catch(t){console.error("postNewStory: error:",t),n(this,s).storeFailed(t.message)}finally{n(this,s).hideSubmitLoadingButton()}}}s=new WeakMap,b=new WeakMap;var g,r,h,f,c,d,a,v,I,k,B,y,E;class K{constructor(){m(this,a);m(this,g);m(this,r);m(this,h);m(this,f,!1);m(this,c,[]);m(this,d,null)}async render(){return q(!1,await w.isPermissionsGeolocationGranted())}async afterRender(){u(this,g,new G({view:this,model:P})),u(this,c,[]),document.querySelector("#map-req")&&document.querySelector("#map-req").addEventListener("click",async()=>{await w.tryGetLocation()}),n(this,g).showNewFormMap(),l(this,a,v).call(this)}async initialMap(){if(!document.querySelector("#map")||(u(this,d,await w.build("#map",{zoom:15})),!n(this,d)))return;const e=n(this,d).getCenter();console.log(n(this,d)),n(this,d).changeCamera([e.latitude,e.longitude]),l(this,a,I).call(this,e.latitude,e.longitude);const t=n(this,d).addMarker([e.latitude,e.longitude],{draggable:"true"});t.addEventListener("move",i=>{const p=i.target.getLatLng();l(this,a,I).call(this,p.lat,p.lng)}),n(this,d).addMapEventListener("click",i=>{t.setLatLng(i.latlng),i.sourceTarget.flyTo(i.latlng)})}storeSuccessfully(e){alert(e),console.log(e),this.clearForm(),location.hash="/"}storeFailed(e){alert(e),console.log(e)}clearForm(){n(this,r).reset()}showMapLoading(){document.getElementById("map-loading-container").innerHTML=N()}hideMapLoading(){document.getElementById("map-loading-container").innerHTML=""}showSubmitLoadingButton(){document.getElementById("submit-button-container").innerHTML=`
      <button class="btn" type="submit" disabled>
        <i class="fas fa-spinner loader-button"></i> Buat Cerita
      </button>
    `}hideSubmitLoadingButton(){document.getElementById("submit-button-container").innerHTML=`
      <button class="btn" type="submit">Buat Cerita</button>
    `}}g=new WeakMap,r=new WeakMap,h=new WeakMap,f=new WeakMap,c=new WeakMap,d=new WeakMap,a=new WeakSet,v=function(){u(this,r,document.getElementById("new-form")),n(this,r).addEventListener("submit",async t=>{if(t.preventDefault(),n(this,r).elements.namedItem("description").value===""){alert("Keterangan tidak boleh kosong");return}if(n(this,c).length===0){alert("Dokumentasi tidak boleh kosong");return}let i={description:n(this,r).elements.namedItem("description").value,photo:n(this,c)[0].blob};await w.isPermissionsGeolocationGranted()&&(i={...i,lat:n(this,r).elements.namedItem("latitude").value,lon:n(this,r).elements.namedItem("longitude").value}),await n(this,g).postNewStory(i)}),document.getElementById("photo-input").addEventListener("change",async t=>{const i=Object.values(t.target.files).map(async p=>await l(this,a,B).call(this,p));await Promise.all(i),await l(this,a,y).call(this)}),document.getElementById("photo-input-button").addEventListener("click",()=>{n(this,r).elements.namedItem("photo-input").click()});const e=document.getElementById("camera-container");document.getElementById("open-photo-camera-button").addEventListener("click",async t=>{l(this,a,k).call(this),u(this,f,e.classList.contains("open")),n(this,f)?(e.classList.remove("open"),t.currentTarget.textContent="Buka Kamera",n(this,h).stop()):(e.classList.add("open"),t.currentTarget.textContent="Tutup Kamera",await n(this,h).launch())})},I=function(e,t){n(this,r).elements.namedItem("latitude").value=e,n(this,r).elements.namedItem("longitude").value=t},k=function(){n(this,h)||u(this,h,new C({video:document.getElementById("camera-video"),cameraSelect:document.getElementById("camera-select"),canvas:document.getElementById("camera-canvas")})),n(this,h).addCheeseButtonListener("#camera-take-button",async()=>{const e=await n(this,h).takePicture();await l(this,a,B).call(this,e),await l(this,a,y).call(this)})},B=async function(e){let t=e;e instanceof String&&(t=F(e,"image/png"));const i={id:`${Date.now()}-${Math.random().toString(36).substring(2,9)}`,blob:t};u(this,c,[...n(this,c),i])},y=async function(){const e=n(this,c).reduce((t,i)=>{const p=URL.createObjectURL(i.blob);return t+x(p,i.id)},"");document.getElementById("photo-taken-list").innerHTML=e,document.querySelectorAll("button[data-index]").forEach(t=>t.addEventListener("click",i=>{const p=i.currentTarget.dataset.index;l(this,a,E).call(this,p),l(this,a,y).call(this)}))},E=function(e){const t=n(this,c).findIndex(i=>(i.id||"").toString()===e.toString());if(t!==-1){const i=document.querySelector(`[data-photo-id="${e}"]`);i&&(i.style.transition="all 0.3s ease",i.style.opacity="0",i.style.transform="scale(0.  8)",setTimeout(()=>{n(this,c).splice(t,1),document.getElementById("photo-input").value="",l(this,a,y).call(this)},300))}};export{K as default};
